{% extends 'base.html.twig' %}

{% block title %}{{ parent() }} - {{ member.displayName }} - Send Message{% endblock %}

{% block body %}
{% embed '_page_header.html.twig' %}
{% block page_header_title %}{{ member.displayName }}{% endblock %}
{% endembed %}

{% include 'member/_badges.html.twig' %}

{% include 'member/_nav.html.twig' %}

{% if member.primaryEmail or member.primaryTelephoneNumber %}
<div class="row">
  <div class="col-lg-7">

    <ul class="nav nav-pills mb-3">
      <li class="nav-item mr-2">
        <a class="nav-link form_button {% if not member.primaryEmail %}disabled{% endif %}" href="#email_form"><i class="fas fa-at fa-fw"></i> Send Email</a>
      </li>
      {% if is_sms_service_configured() %}
      <li class="nav-item">
        <a class="nav-link form_button {% if not member.primaryTelephoneNumber %}disabled{% endif %}" href="#sms_form"><i class="fas fa-sms fa-fw"></i> Send SMS</a>
      </li>
      {% endif %}
    </ul>

    {% if member.primaryEmail %}
    <div id="email_form" class="message_form">
      {{ form_start(formEmail) }}
      <div class="card mb-3 shadow">
        <div class="card-body">
          {{ form_row(formEmail.subject) }}
          {{ form_row(formEmail.message_body) }}
          {{ form_row(formEmail.reply_to) }}
          {{ form_row(formEmail.send_copy) }}
        </div>
      </div>
      <div class="text-right mb-3">
        {{ form_widget(formEmail.submit) }}
      </div>
      {{ form_rest(formEmail) }}
      {{ form_end(formEmail) }}
    </div>
    {% endif %}

    {% if is_sms_service_configured() and member.primaryTelephoneNumber %}
    <div id="sms_form" class="message_form">
      {{ form_start(formSMS) }}
      <div class="card mb-3 shadow">
        <div class="card-body">
          {{ form_row(formSMS.message_body) }}
        </div>
      </div>
      <div class="text-right mb-3">
        {{ form_widget(formSMS.submit) }}
      </div>
      {{ form_rest(formSMS) }}
      {{ form_end(formSMS) }}
    </div>
    {% endif %}
  </div>
  <div class="col-lg-5">
    <h4>Recent Communications</h4>
    {% for log in recentCommunications %}
    <div class="card shadow mb-2">
      <div class="card-body p-3">
        {{ log.summary|markdown_to_html }}
      </div>
      <div class="card-footer small p-2">
        <div class="row mb-0">
          <div class="col-4">
            {{ log.typeDisplay }}
          </div>
          <div class="col-8 text-right">
            {{ log.loggedAt|date('n/j/Y h:i a', app.user.timezone)}} - {{ log.user|default('System') }} <a href="{{ path('communication_edit', {id: log.id }) }}"><i class="fas fa-edit"></i></a>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    {% include '_no_records_card.html.twig' with {message: 'No recent Communications with this member.', size: 'sm'} %}
    {% endfor %}
  </div>
</div>
{% else %}
{% include '_no_records_card.html.twig' with {message: 'Member must have either an Email or Telephone number to receive messages.'} %}
{% endif %}
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
$(document).ready(function () {
  $('.message_form').hide();
  $('.message_form').first().show();
  $('.form_button').first().addClass('active');
  $('.form_button').on('click', function (element) {
    $('.form_button').removeClass('active');
    $(element.target).addClass('active');
    $('.message_form').hide();
    var selector = $(element.target).attr('href');
    $(selector).show();
  })
})
</script>
{% endblock %}
